/**
 * SeaSalt Pickles - Orders Page Fix + WhatsApp + Wallet Timer v2
 * ================================================================
 * LOADS AFTER app.js â€” patches everything directly.
 *
 * FIXES:
 *  1. Orders page was showing old compressed modal â€” now beautiful full-screen
 *  2. Order total showing â‚¹0 â€” reads all field-name variants from cart.js
 *  3. WhatsApp message on checkout â€” patches Cart.checkout flow
 *  4. Wallet timer shows 719 hrs â€” patches UI.startWalletTimer to show d/h/m
 *
 * DEPLOY: <script src="js/orders-fix.js"></script>  (AFTER app.js in index.html)
 */

;(function() {
    'use strict';

    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  CONFIG                                       â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    var STORE_PHONE = '919963971447';
    var ORDERS_KEY  = 'seasalt_orders';

    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  1. ORDERS PAGE â€” Full-screen beautiful UI    â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showOrdersPage() {
        var orders = getOrders();

        // Remove any existing modals
        var old = document.getElementById('orders-modal');
        if (old) old.remove();

        var modal = document.createElement('div');
        modal.id = 'orders-modal';
        modal.style.cssText = 'position:fixed;inset:0;z-index:86;display:flex;align-items:flex-end;justify-content:center;';

        // Backdrop
        var backdrop = document.createElement('div');
        backdrop.style.cssText = 'position:absolute;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);';
        backdrop.onclick = function() { closeModal(modal); };
        modal.appendChild(backdrop);

        // Panel
        var panel = document.createElement('div');
        panel.style.cssText = 'position:relative;background:#fff;border-radius:24px 24px 0 0;width:100%;max-width:480px;max-height:85vh;display:flex;flex-direction:column;animation:slideUp .3s ease;';
        modal.appendChild(panel);

        // Header
        var header = document.createElement('div');
        header.style.cssText = 'padding:20px 20px 16px;border-bottom:1px solid #f3f4f6;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;';
        header.innerHTML = '<div><h3 style="font-weight:800;font-size:1.25rem;color:#1f2937;margin:0;">My Orders</h3>' +
            '<p style="font-size:0.8rem;color:#9ca3af;margin:4px 0 0;">' + orders.length + ' order' + (orders.length !== 1 ? 's' : '') + '</p></div>' +
            '<button id="close-orders-btn" style="width:36px;height:36px;border-radius:50%;background:#f3f4f6;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.1rem;">âœ•</button>';
        panel.appendChild(header);

        header.querySelector('#close-orders-btn').onclick = function() { closeModal(modal); };

        // Body (scrollable)
        var body = document.createElement('div');
        body.style.cssText = 'flex:1;overflow-y:auto;padding:16px 20px 24px;';
        panel.appendChild(body);

        if (orders.length === 0) {
            body.innerHTML = '<div style="text-align:center;padding:60px 0;">' +
                '<div style="font-size:4rem;margin-bottom:16px;">ğŸ“¦</div>' +
                '<h4 style="font-weight:700;color:#1f2937;font-size:1.1rem;margin:0 0 8px;">No orders yet</h4>' +
                '<p style="color:#9ca3af;font-size:0.9rem;margin:0;">Your orders will appear here after checkout</p></div>';
        } else {
            orders.forEach(function(order) {
                body.appendChild(buildOrderCard(order));
            });
        }

        document.body.appendChild(modal);
        document.body.style.overflow = 'hidden';

        // Add animation keyframe
        if (!document.getElementById('orders-fix-style')) {
            var s = document.createElement('style');
            s.id = 'orders-fix-style';
            s.textContent = '@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}';
            document.head.appendChild(s);
        }
    }

    function closeModal(modal) {
        modal.remove();
        document.body.style.overflow = '';
    }

    function buildOrderCard(order) {
        var card = document.createElement('div');
        card.style.cssText = 'background:#f9fafb;border-radius:16px;padding:16px;margin-bottom:12px;border:1px solid #f3f4f6;';

        // â”€â”€â”€ Read fields (cart.js uses camelCase, Supabase uses snake_case) â”€â”€â”€
        var orderId = order.id || order.orderId || order.order_id || '???';
        var status  = order.status || 'pending';
        var date    = order.createdAt || order.created_at || order.date || '';
        var total   = parseFloat(order.total) || 0;

        // Items â€” could be string (from Supabase) or array
        var items = [];
        try {
            items = typeof order.items === 'string' ? JSON.parse(order.items) : (order.items || []);
        } catch(e) {}

        // Item count
        var itemCount = 0;
        items.forEach(function(it) { itemCount += (it.quantity || 1); });

        // If total is 0, try to calculate from items
        if (total === 0 && items.length > 0) {
            items.forEach(function(it) {
                total += (parseFloat(it.price) || 0) * (it.quantity || 1);
            });
            // Add delivery
            var del = parseFloat(order.delivery || order.deliveryCharge || order.delivery_charge || 0);
            total += del;
            // Subtract wallet
            var wd = parseFloat(order.walletUsed || order.walletDiscount || order.wallet_used || 0);
            total -= wd;
            if (total < 0) total = 0;
        }

        // Status styling
        var statusConfig = {
            'confirmed':  { bg: '#dcfce7', color: '#166534', icon: 'âœ…', label: 'Confirmed' },
            'pending':    { bg: '#fef3c7', color: '#92400e', icon: 'â³', label: 'Pending' },
            'shipped':    { bg: '#dbeafe', color: '#1e40af', icon: 'ğŸšš', label: 'Shipped' },
            'delivered':  { bg: '#d1fae5', color: '#065f46', icon: 'ğŸ‰', label: 'Delivered' },
            'cancelled':  { bg: '#fee2e2', color: '#991b1b', icon: 'âŒ', label: 'Cancelled' },
            'processing': { bg: '#e0e7ff', color: '#3730a3', icon: 'âš™ï¸', label: 'Processing' }
        };
        var sc = statusConfig[status] || statusConfig['pending'];

        // Date formatting
        var dateStr = '';
        if (date) {
            try {
                var d = new Date(date);
                dateStr = d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) +
                    ', ' + d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true });
            } catch(e) { dateStr = date; }
        }

        // â”€â”€â”€ Build HTML â”€â”€â”€
        // Header row: Order ID + Status badge
        var headerRow = '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">' +
            '<div style="font-weight:700;color:#1f2937;font-size:0.95rem;">#' + orderId + '</div>' +
            '<span style="display:inline-flex;align-items:center;gap:4px;font-size:0.75rem;font-weight:600;padding:4px 10px;border-radius:20px;background:' + sc.bg + ';color:' + sc.color + ';">' + sc.icon + ' ' + sc.label + '</span></div>';

        // Date
        var dateRow = dateStr ? '<div style="font-size:0.8rem;color:#9ca3af;margin-bottom:10px;">' + dateStr + '</div>' : '';

        // Items list
        var itemsHtml = '';
        items.forEach(function(it) {
            var name = it.name || 'Item';
            var size = it.size || it.weight || it.variant || '';
            var qty  = it.quantity || 1;
            var price = parseFloat(it.price) || 0;
            itemsHtml += '<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:0.85rem;">' +
                '<span style="color:#4b5563;">' + name + (size ? ' (' + size + ')' : '') + ' Ã— ' + qty + '</span>' +
                '<span style="font-weight:600;color:#374151;">â‚¹' + (price * qty) + '</span></div>';
        });
        if (itemsHtml) {
            itemsHtml = '<div style="border-top:1px solid #e5e7eb;padding-top:8px;margin-bottom:8px;">' + itemsHtml + '</div>';
        }

        // Footer: item count + total
        var footerRow = '<div style="display:flex;justify-content:space-between;align-items:center;border-top:1px solid #e5e7eb;padding-top:8px;">' +
            '<span style="font-size:0.85rem;color:#6b7280;">' + itemCount + ' item' + (itemCount !== 1 ? 's' : '') + '</span>' +
            '<span style="font-weight:800;font-size:1.1rem;color:#1f2937;">â‚¹' + total + '</span></div>';

        card.innerHTML = headerRow + dateRow + itemsHtml + footerRow;
        return card;
    }

    function getOrders() {
        var orders = [];
        try { orders = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]'); } catch(e) {}

        // Sort newest first â€” handle all date field names
        orders.sort(function(a, b) {
            var da = new Date(a.createdAt || a.created_at || a.date || 0).getTime();
            var db = new Date(b.createdAt || b.created_at || b.date || 0).getTime();
            return db - da;
        });
        return orders;
    }


    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  2. PATCH ORDERS NAV BUTTON DIRECTLY          â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //
    // app.js binds nav clicks at load time â†’ our fix loads after â†’ 
    // we must OVERRIDE the nav button click handler.

    function patchOrdersNav() {
        // Find the Orders nav button
        var navBtns = document.querySelectorAll('#bottom-nav .nav-item, #bottom-nav button[data-page]');
        navBtns.forEach(function(btn) {
            if (btn.getAttribute('data-page') === 'orders') {
                // Clone and replace to remove all old event listeners
                var newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);

                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Update active nav state
                    document.querySelectorAll('#bottom-nav .nav-item, #bottom-nav button[data-page]').forEach(function(b) {
                        b.classList.remove('active');
                        b.style.color = '';
                    });
                    newBtn.classList.add('active');
                    newBtn.style.color = '#D4451A';

                    showOrdersPage();
                });
                console.log('[OrdersFix] âœ… Orders nav button patched');
            }
        });
    }


    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  3. WHATSAPP NOTIFICATION ON CHECKOUT         â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function sendWhatsAppNotification(order) {
        if (!STORE_PHONE || STORE_PHONE === '919876543210') {
            console.warn('[OrdersFix] WhatsApp not configured â€” update STORE_PHONE');
            return;
        }

        var items = [];
        try { items = typeof order.items === 'string' ? JSON.parse(order.items) : (order.items || []); } catch(e) {}

        var customer = order.customer || order.address || {};
        var custName = customer.name || order.customer_name || 'Customer';
        var custPhone = customer.phone || order.customer_phone || '';

        var msg = 'ğŸ§‚ *SeaSalt Pickles â€” New Order!*\n\n' +
            'ğŸ“‹ *Order ID:* #' + (order.id || order.orderId) + '\n' +
            'ğŸ‘¤ *Customer:* ' + custName + '\n' +
            'ğŸ“± *Phone:* ' + custPhone + '\n';

        var date = order.createdAt || order.created_at || new Date().toISOString();
        try {
            var d = new Date(date);
            msg += 'ğŸ“… *Date:* ' + d.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' }) +
                ', ' + d.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', hour12: true }) + '\n';
        } catch(e) {}

        msg += '\nğŸ›’ *Items:*\n';
        var calcTotal = 0;
        items.forEach(function(it, i) {
            var name = it.name || 'Item';
            var size = it.size || it.weight || '';
            var qty = it.quantity || 1;
            var price = parseFloat(it.price) || 0;
            var lineTotal = price * qty;
            calcTotal += lineTotal;
            msg += (i + 1) + '. ' + name + (size ? ' (' + size + ')' : '') + ' Ã— ' + qty + ' = â‚¹' + lineTotal + '\n';
        });

        var total = parseFloat(order.total) || calcTotal;
        msg += '\nğŸ’° *Total: â‚¹' + total + '*\n\nThank you for ordering! ğŸ™';

        var url = 'https://wa.me/' + STORE_PHONE + '?text=' + encodeURIComponent(msg);
        window.open(url, '_blank');
    }

    // Patch Cart.checkout to also send WhatsApp
    function patchCheckout() {
        if (typeof Cart === 'undefined' || !Cart.checkout) return;

        var _origCheckout = Cart.checkout;

        Cart.checkout = function() {
            // Capture cart items BEFORE checkout clears them
            var cartSnapshot = null;
            try {
                if (typeof Store !== 'undefined' && Store.getCart) {
                    cartSnapshot = JSON.parse(JSON.stringify(Store.getCart()));
                }
            } catch(e) {}

            // Watch for new order appearing in localStorage
            var ordersBefore = [];
            try { ordersBefore = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]'); } catch(e) {}
            var countBefore = ordersBefore.length;

            // Call original checkout
            _origCheckout.apply(Cart, arguments);

            // Poll for new order (checkout is async with Razorpay)
            var checks = 0;
            var checker = setInterval(function() {
                checks++;
                if (checks > 120) { clearInterval(checker); return; } // Stop after 2 min

                var ordersNow = [];
                try { ordersNow = JSON.parse(localStorage.getItem(ORDERS_KEY) || '[]'); } catch(e) {}

                if (ordersNow.length > countBefore) {
                    clearInterval(checker);
                    var newOrder = ordersNow[0]; // newest is first
                    console.log('[OrdersFix] New order detected:', newOrder.id || newOrder.orderId);

                    // Send WhatsApp after a small delay (let success modal show first)
                    setTimeout(function() {
                        sendWhatsAppNotification(newOrder);
                    }, 2000);
                }
            }, 1000);
        };

        console.log('[OrdersFix] âœ… Cart.checkout patched for WhatsApp');
    }


    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  4. WALLET TIMER FIX                          â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //
    // Problem: UI.startWalletTimer shows raw hours (719:59:42 for 30 days).
    // Fix: Override to show days/hours/minutes properly.

    function patchWalletTimer() {
        if (typeof UI === 'undefined') return;

        // Override startWalletTimer
        UI.startWalletTimer = function() {
            // Clear any existing timer
            if (window._walletTimerInterval) {
                clearInterval(window._walletTimerInterval);
                window._walletTimerInterval = null;
            }

            // Find the wallet expiry time from all possible sources
            var expiresAt = null;
            var sources = ['seasalt_spin_wallet', 'seasalt_admin_credit', 'seasalt_spin_reward'];

            for (var i = 0; i < sources.length; i++) {
                try {
                    var raw = localStorage.getItem(sources[i]);
                    if (raw) {
                        var data = JSON.parse(raw);
                        if (data && data.expiresAt) {
                            var exp = new Date(data.expiresAt);
                            if (exp > new Date()) {
                                // Use the SOONEST expiry (admin credit 48hr is more urgent than spin 30day)
                                if (!expiresAt || exp < expiresAt) {
                                    expiresAt = exp;
                                }
                            }
                        }
                    }
                } catch(e) {}
            }

            if (!expiresAt) return; // No active wallet

            function updateTimerDisplay() {
                var now = new Date();
                var diff = expiresAt - now;

                if (diff <= 0) {
                    // Expired â€” clean up
                    var walletBtn = document.getElementById('wallet-btn');
                    var timerEl = walletBtn ? walletBtn.querySelector('.wallet-timer') : null;
                    if (timerEl) timerEl.remove();
                    clearInterval(window._walletTimerInterval);
                    window._walletTimerInterval = null;
                    return;
                }

                var totalSeconds = Math.floor(diff / 1000);
                var days    = Math.floor(totalSeconds / 86400);
                var hours   = Math.floor((totalSeconds % 86400) / 3600);
                var minutes = Math.floor((totalSeconds % 3600) / 60);
                var seconds = totalSeconds % 60;

                // Smart format:
                //   > 1 day  â†’ "2d 5h left"
                //   < 1 day  â†’ "23:45:12"
                //   < 1 hour â†’ "45:12"
                var text = '';
                if (days > 0) {
                    text = days + 'd ' + hours + 'h left';
                } else if (hours > 0) {
                    text = pad(hours) + ':' + pad(minutes) + ':' + pad(seconds);
                } else {
                    text = pad(minutes) + ':' + pad(seconds);
                }

                // Find or create timer element next to wallet button
                var walletBtn = document.getElementById('wallet-btn');
                if (!walletBtn) return;

                var timerEl = walletBtn.querySelector('.wallet-timer');
                if (!timerEl) {
                    timerEl = document.createElement('span');
                    timerEl.className = 'wallet-timer';
                    timerEl.style.cssText = 'font-size:0.65rem;color:#b45309;margin-left:4px;white-space:nowrap;';
                    walletBtn.appendChild(timerEl);
                }
                timerEl.textContent = 'â± ' + text;
            }

            // Run immediately + every second
            updateTimerDisplay();
            window._walletTimerInterval = setInterval(updateTimerDisplay, 1000);
        };

        // Run the patched timer immediately
        UI.startWalletTimer();
        console.log('[OrdersFix] âœ… Wallet timer patched');
    }

    function pad(n) { return n < 10 ? '0' + n : '' + n; }


    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  5. INIT â€” Apply all patches                  â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function init() {
        console.log('[OrdersFix] v2 initializing...');
        patchOrdersNav();
        patchCheckout();
        patchWalletTimer();
        console.log('[OrdersFix] v2 âœ… All patches applied');
    }

    // Run when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        // DOM already loaded â€” run with tiny delay to ensure app.js has finished
        setTimeout(init, 100);
    }

    // â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    // â•‘  EXPORTS                                      â•‘
    // â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    window.OrdersFix = {
        showOrdersPage: showOrdersPage,
        sendWhatsApp: sendWhatsAppNotification
    };

})();
